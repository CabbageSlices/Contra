#include "Player.h"

Player::Player(const PlayerKeys& keyConfiguration):
    MOVEMENT_VELOCITY(4.f, 3.8f),
    canJump(false),
    holdingJump(false),
    extraJumpTimer(),
    extraJumpDuration(sf::milliseconds(220)),
    positionController(glm::vec2(64, 64), glm::vec2(0, GRAVITY), glm::vec2(TERMINAL_VELOCITY, TERMINAL_VELOCITY), glm::vec2(0), glm::vec2(0, 1)),
    player(sf::Vector2f(64, 64)),
    controls(keyConfiguration)
    {

    }

void Player::handleInputEvents(sf::Event& event, sf::RenderWindow& window) {

}

void Player::handleKeystate(sf::RenderWindow& window) {

    if(sf::Keyboard::isKeyPressed(controls.left)) {

        positionController.setVelocities(-MOVEMENT_VELOCITY.x, positionController.getVelocitiesWorldSpace().y);

    } else if(sf::Keyboard::isKeyPressed(controls.right)) {

        positionController.setVelocities(MOVEMENT_VELOCITY.x, positionController.getVelocitiesWorldSpace().y);

    } else {

        positionController.setVelocities(0, positionController.getVelocitiesWorldSpace().y);
    }

    if(sf::Keyboard::isKeyPressed(controls.jump)) {

        jump();
    }

    holdingJump = sf::Keyboard::isKeyPressed(controls.jump);
}

void Player::update(const float& deltaTime, const sf::FloatRect& worldBounds) {

    //since player velocity only changes in the y direction you can prevent gravity from pulling player down
    //when player is holding jump button and trying ot extend his jump height dont let gravity pull player down
    if(!checkExtendJump()) {

        positionController.updateVelocities(deltaTime);
    }

    positionController.moveAlongXAxis(deltaTime, worldBounds);

    if(positionController.moveAlongYAxis(deltaTime, worldBounds)) {

        canJump = true;
    }

    player.setPosition(positionController.getBoundingBoxWorldSpace().left, positionController.getBoundingBoxWorldSpace().top);
}

void Player::draw(sf::RenderWindow& window) {

    window.draw(player);
}

void Player::jump() {

    if(canJump) {

        extraJumpTimer.restart();
        positionController.setVelocities(positionController.getVelocitiesWorldSpace().x, -MOVEMENT_VELOCITY.y);
        canJump = false;
    }
}
